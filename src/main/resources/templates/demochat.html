<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-header">
        <h1 id="chatTitle">Chat</h1>
    </div>

    <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
            No messages yet. Start the conversation!
        </div>
    </div>

    <div class="input-container">
        <textarea 
            class="message-input" 
            id="messageInput" 
            placeholder="Type a message..."
            rows="1"
        ></textarea>
        <button class="send-button" id="sendButton">â†’</button>
    </div>

    <script>
        const client=new StompJs.Client();
        client.brokerURL='http://localhost:8080/ws';
        client.onConnect=function(frame)
        {
            const chat = new ChatApp();
            window.chatApp = chat;
            const subscription = client.subscribe('queue/direct', function(message)
            {
                alert(message.body);
            });
            if(url.searchParams.has('user'))
            {client.publish({destination:'/app/direct', body:'Hello '+url.searchParams.get('user')});}
        }
        class ChatApp {
            constructor() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatTitle = document.getElementById('chatTitle');
                
                this.currentUser = 'You';
                this.otherUser = this.getOtherUserFromQuery();
                
                this.init();
            }

            getOtherUserFromQuery() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('user') || 'Other User';
            }

            init() {
                this.chatTitle.textContent = `Chat with ${this.otherUser}`;
                this.setupEventListeners();
                this.autoResizeTextarea();
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.messageInput.addEventListener('input', () => {
                    this.autoResizeTextarea();
                });
            }

            autoResizeTextarea() {
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 100) + 'px';
            }

            addMessage(text, sender) {
                const isEmpty = this.messagesContainer.querySelector('.empty-state');
                if (isEmpty) {
                    isEmpty.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender === this.currentUser ? 'me' : 'other'}`;
                
                const timeString = this.formatTimestamp(timestamp);
                
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="username">${sender}</div>
                        <div class="message-text">${this.escapeHtml(text)}</div>
                    </div>
                `;

                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            sendMessage() {
                const text = this.messageInput.value.trim();
                if (!text) return;

                // Add message to UI immediately
                this.addMessage(text, this.currentUser);
                
                // Send to backend
                this.sendToBackend(text);
                
                // Clear input
                this.messageInput.value = '';
                this.autoResizeTextarea();
            }

            async sendToBackend(message) {
                try {
                    // Replace with your actual backend endpoint
                    const response = await fetch('/api/send-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            to: this.otherUser
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }

                    console.log('Message sent successfully');
                } catch (error) {
                    console.error('Error sending message:', error);
                    // You might want to show an error message to the user
                }
            }

            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                
                if (isToday) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + 
                           date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            // Method to populate messages from backend
            loadMessages(messages) {
                this.messagesContainer.innerHTML = '';
                
                messages.forEach(msg => {
                    this.addMessage(msg.text, msg.sender);
                });
            }

            // Method to add a message from the other user (for real-time updates)
            receiveMessage(text) {
                this.addMessage(text, this.otherUser);
            }
        }

        // Initialize the chat app

        // Example usage for populating messages from backend:
        // const exampleMessages = [
        //     { text: "Hello there!", sender: "Alice" },
        //     { text: "Hi Alice! How are you?", sender: "You" },
        //     { text: "I'm doing great, thanks for asking!", sender: "Alice" }
        // ];
        // chat.loadMessages(exampleMessages);

        // Example usage for receiving a message:
        // chat.receiveMessage("This is a new message from the other user");

        // Make chat instance globally available for backend integration
    </script>
</body>
</html>